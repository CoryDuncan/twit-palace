<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title></title>
	<script type='text/javascript' src="../lib/d3.js"></script>
	<script type='text/javascript' src="../lib/underscore.js"></script>
	<script type='text/javascript' src="keywords.js"></script>
<style>
	*{
		box-sizing: border-box;
	}
	div{
		border: 0px solid silver;
	}
	text {
		font: 24px "Helvetica Neue", Helvetica, Arial, sans-serif;
		text-anchor: middle;
		pointer-events: none;
	}
	circle {
		fill: #ccc;
	}
	.node:hover circle, .node.selected circle {
		stroke: black;
		stroke-width: 3px;
	}
	.top circle{
		fill: none;
		stroke: silver;
	}
	#outside-container{
		margin: 0 auto;
	}
	#legend{
		float: left;
		width: 150px;
	}
</style>
</head>
<body>

<div id="outside-container">
	<div id="legend"></div>
	<div id="visu"></div>
	<div id="keyword"></div>
</div>

<script>

	var keywordsEntries = [];
	keywords.forEach(function(d, i){
		keywordsEntries.push({key: d.keyword, value: d.count, event: d.event});
	});

	var keywordContainer = d3.select('#keyword');

	// bubble chart
	var bleed = 10,
		width = 800,
		height = 800;

	var colors = d3.scale.category20c();

	var pack = d3.layout.pack()
		.sort(null)
		.size([width, height + bleed * 2])
		.padding(2)
		.value(function(d){return d.value; });

	var svg = d3.select("#visu").append("svg")
		.attr("width", width)
		.attr("height", height)
		.append("g")
		.attr("transform", "translate(0," + -bleed + ")");

	var keywordContainer = d3.select('#keyword');

	function renderBubbles(_keywordsEntries){

		var node = svg.selectAll("g")
			.data(pack.nodes({key: '', value: 1, children: _keywordsEntries}), function(d, i){ return d.key; });

		var nodeEnter = node.enter().append("g")
			.classed("node", function(d){ return d.depth > 0;})
			.classed("top", function(d){ return d.depth === 0;})
			.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })

		nodeEnter.append("circle")
			.style({opacity: 0})
			.attr("r", function(d) { return d.r; })
			.on('mouseenter', function(d, i){
				keywordContainer.html(d.key);
			})
			.on('click', function(d, i){
				console.log(d.key);
			});
		nodeEnter.append("text")
			.attr({dy: ".35em"})
			.style({opacity: 0});

		var nodeTransition = node.transition().duration(500);
		nodeTransition.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
		nodeTransition.selectAll("circle")
			.style({fill: function(d, i){
					if(d.depth === 0) return null;
					return colors(d.event);
				},
				opacity: 1
			})
			.attr("r", function(d){ return d.r; });
		node.selectAll('text')
			.filter(function(d){ return d.r > 10; })
			.text(function(d){ return d.key; })
			.style({'font-size': '24px'})
			.transition().duration(300)
//			.style("font-size", function(d) { return Math.min(2 * d.r, (2 * d.r - 8) / this.getComputedTextLength() * 24) + "px"; });
			.style({'font-size': function(d){
//					return d.r / d.key.length * 4 + "px";
					return Math.min(2 * d.r, (2 * d.r - 8) / this.getComputedTextLength() * 24) + "px";
//					return Math.min(2 * d.r, (2 * d.r - 8) / this.getBBox().width * 24) + "px";
				},
				opacity: 1
			});

		node.exit().transition().style({opacity: 0}).remove();

	}


	var legendSelected = null;
	function renderLegend(){
		var allEvents = keywords.map(function(d){ return d.event; });
		var eventCount = allEvents.reduce(function(pVal, val, i, arr){
			if(!pVal[val]){ pVal[val] = 0; }
			pVal[val]++;
			return pVal;
		}, {});
		var uniqueEvents = d3.keys(eventCount);
		var html = '';
		uniqueEvents.forEach(function(d){
			html += '<div class="legend-item" style="background-color:'+colors(d)+'">'+d+'</div>';
		});
		d3.select('#legend').html(html);
		d3.selectAll('.legend-item').on('mouseover', function(d, i){
				if(i !== 0){
					var event = uniqueEvents[i];
					d3.selectAll('.node').classed('selected', function(d){ return d.event === event; });
				}
			})
			.on('click', function(d, i){
				var event = uniqueEvents[i];
				console.log(event);
				if(event === legendSelected){
					legendSelected = null;
					renderBubbles(keywordsEntries);
				}
				else{
					legendSelected = event;
					var event = uniqueEvents[i] ;
					var keywordsEntriesFiltered = keywordsEntries.filter(function(d, i){ return d.event === event; });
					renderBubbles(keywordsEntriesFiltered);
				}
			});
	}

	renderBubbles(keywordsEntries);
	renderLegend();

</script>

</body>
</html>