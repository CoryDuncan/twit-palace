<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title></title>
	<script type='text/javascript' src="../lib/d3.js"></script>
	<script type='text/javascript' src="../lib/underscore.js"></script>
	<style>
		*{
			box-sizing: border-box;
		}
		div{
			border: 1px solid silver;
			color: silver;
		}
		#list-container{
			width: 600px;
			height: 400px;
			overflow: auto;
		}
		#selected-tweet-container{
			width: 600px;
			height: 150px;
			color: black;
			font-size: 20px;
		}
		#controls-container{
			width: 600px;
			height: 50px;
		}
		.tweet-list{
			list-style-type: none;
			padding: 0;
			margin: 0;
		}
		.tweet-list li{
			height: 50px;
			border: 1px #eee solid;
		}
		.keyword{
			color: black;
		}
		.next-button{
			width: 50px;
			height: 50px;
			cursor: pointer;
		}
	</style>
</head>
<body>

<script type="template" id="tweet-list-tpl">
<li>{selected} {formattedTweet}</li>
</script>

<div id="selected-tweet-container">

</div>

<div id="controls-container">
	<div class="next-button">Next</div>
</div>

<div id="list-container">
	<ul class="tweet-list"></ul>
</div>

<script>

	function throttle (callback, limit) {
		var wait = false, timer;
		return function () {
			if (!wait) {
				callback.call();
				wait = true;
				clearTimeout(timer);
				timer = setTimeout(function () {
					wait = false;
				}, limit);
			}
		}
	}

function countOccurences(arr){
	var counts = {};
	for(var i = 0; i< arr.length; i++) {
		var num = arr[i];
		counts[num] = counts[num] ? counts[num]+1 : 1;
	}
	return counts;
}

	var compileTemplate = function(_template, _values){
		return [].concat(_values).map(function(d, i){
			return _template.replace(/{([^}]*)}/g, function(s, key){return d[key] || '';});
		}).join('\n');
	};

	var keywords = {
		"lunettes": 4,
		"l'arrestation": 4,
		"Tramell": 4,
		"Emmert": 4,
		"Miellot": 2,
		"Mickey": 4,
		"Julien": 3,
		"PlanetRomeo": 4,
		"hôtel": 4,
		"taxi": 3,
		"cadeau": 4,
		"Chan": 3,
		"morgue": 2,
		"déshabiller": 2,
		"marteau": 5,
		"ciseaux": 4,
		"tournevis": 3,
		"couteau": 2,
		"Massa": 4,
		"profanation": 4,
		"horribles": 2,
		"Panagiotis": 4,
		"ligoté": 2,
		"choquantes": 2,
		"candide": 2,
		"Londres": 3,
		"Kilbride": 2,
		"tué": 4,
		"chats": 2,
		"Postes": 3,
		"Gatineau": 2,
		"Facebook": 3,
		"Tomokazu": 3,
		"PJC": 4,
		"sexuelle": 3,
		"toxicologique": 3,
		"génétique": 4,
		"schizophrène": 2,
		"Chine": 4,
		"coupable": 4,
		"cadavre": 4,
		"détention": 2,
		"nu": 2,
		"Berlin": 38,
		"repris": 8,
		"dépose": 13,
		"Fin": 74,
		"témoignage": 62,
		"Leymann": 14,
		"policiers": 20,
		"l'interrogatoire": 21,
		"Thomas": 5,
		"calme": 6,
		"vu": 26,
		"images": 20,
		"Google": 6,
		"policier": 23,
		"Lilge": 19,
		"café": 18,
		"Internet": 25,
		"témoin": 66,
		"enregistré": 16,
		"répondu": 8,
		"Luc": 25,
		"Leclair": 128,
		"problème": 10,
		"poursuit": 14,
		"anglais": 5,
		"lit": 14,
		"amis": 7,
		"Kirk": 7,
		"départ": 9,
		"criminel": 6,
		"collègue": 6,
		"Nouveau": 29,
		"dernier": 16,
		"décrit": 21,
		"rencontre": 10,
		"rencontré": 13,
		"Huebner": 11,
		"explique": 80,
		"arrêté": 5,
		"présente": 36,
		"commis": 8,
		"police": 45,
		"Témoin": 21,
		"photos": 58,
		"arrivée": 8,
		"photo": 14,
		"matin": 15,
		"contre-interrogatoire": 23,
		"nouveau": 15,
		"vidéos": 34,
		"surveillance": 12,
		"L'avocat": 29,
		"détails": 6,
		"client": 9,
		"France": 6,
		"l'aéroport": 7,
		"Montréal": 20,
		"Cournoyer": 24,
		"prévient": 9,
		"Miello": 22,
		"passeport": 6,
		"français": 13,
		"billet": 9,
		"Robert": 45,
		"dormi": 7,
		"poubelle": 5,
		"appris": 10,
		"trouvé": 16,
		"Soumman": 6,
		"Paris": 18,
		"retrouvés": 14,
		"Novotel": 7,
		"contacté": 8,
		"ligne": 14,
		"téléphone": 6,
		"rappelle": 6,
		"jurés": 13,
		"site": 13,
		"retrouvé": 21,
		"vol": 9,
		"vidéo": 74,
		"sécurité": 5,
		"Georges": 5,
		"prévenu": 13,
		"colis": 44,
		"appelé": 19,
		"Jones": 6,
		"appelle": 14,
		"envoyé": 13,
		"l'école": 9,
		"reçu": 35,
		"envoyés": 7,
		"directeur": 5,
		"False": 7,
		"Creek": 7,
		"corps": 29,
		"Chow": 6,
		"envoyée": 10,
		"note": 16,
		"manuscrite": 5,
		"contenait": 10,
		"contenu": 9,
		"judiciaire": 23,
		"policière": 22,
		"Vancouver": 10,
		"témoigne": 11,
		"meurtre": 18,
		"reconnu": 8,
		"l'hôtel": 11,
		"Toronto": 5,
		"semaine": 10,
		"Bouthillier": 8,
		"Desjardins": 17,
		"scie": 12,
		"retrouvée": 10,
		"ordures": 5,
		"cage": 5,
		"traduction": 6,
		"l'avocat": 18,
		"marteau": 5,
		"marques": 8,
		"trace": 6,
		"os": 7,
		"blessures": 8,
		"traces": 7,
		"témoigner": 9,
		"déclaré": 5,
		"expert": 7,
		"défense": 16,
		"pathologiste": 7,
		"Dazé": 43,
		"expertise": 6,
		"armes": 6,
		"Bordelais": 6,
		"PCC": 5,
		"Lethon": 8,
		"cheveux": 7,
		"identifié": 5,
		"carte": 9,
		"valise": 16,
		"travaillait": 7,
		"Frank": 16,
		"Faith": 5,
		"filmée": 6,
		"ordi": 9,
		"crimes": 18,
		"technologiques": 11,
		"mémoire": 9,
		"Sarganis": 37,
		"extrait": 8,
		"enquêteurs": 5,
		"IP": 5,
		"courriel": 15,
		"dernière": 6,
		"SPVM": 12,
		"extraits": 7,
		"Lin": 77,
		"Jun": 62,
		"mort": 23,
		"filmées": 11,
		"scène": 12,
		"crime": 14,
		"Rappelons": 5,
		"débat": 18,
		"adresse": 12,
		"journaliste": 9,
		"Alex": 10,
		"West": 61,
		"victime": 14,
		"vie": 5,
		"reçues": 5,
		"responsable": 5,
		"Paoliello": 29,
		"boîte": 6,
		"Pombert": 6,
		"montre": 15,
		"place": 7,
		"sac": 8,
		"vidange": 6,
		"postal": 6,
		"individu": 7,
		"revient": 15,
		"Valentini": 10,
		"Chrétien": 10,
		"Nadine": 5,
		"Lee": 7,
		"boîtes": 5,
		"Tremblay": 10,
		"perruque": 5,
		"caméras": 11,
		"vin": 5,
		"Catherine": 5,
		"Lavallée": 28,
		"substances": 6,
		"Yann": 6,
		"Paradiso": 16,
		"Hamlin": 19,
		"Xu": 22,
		"items": 7,
		"l'immeuble": 19,
		"Décarie": 9,
		"biologiste": 7,
		"Prévost": 51,
		"matelas": 5,
		"l'appartement": 8,
		"sang": 16,
		"bain": 6,
		"vêtements": 6,
		"appartement": 7,
		"infligées": 6,
		"Rubert": 70,
		"buvait": 5,
		"clavardage": 5,
		"ami": 7,
		"terminal": 5,
		"Murphy": 12,
		"concierge": 5,
		"Feng": 16,
		"l'enquêteuse": 6,
		"noir": 5,
		"immeuble": 5,
		"Hamelin": 12,
		"sacs": 7,
		"Nadeau": 8,
		"Schorer": 5,
		"Simoneau": 33,
		"Savard": 9,
		"conjoint": 5,
		"Dionne": 5,
		"Turmel": 9,
		"poubelles": 7
	};

	var tweets;
	d3.csv('magnotta_tweets_Messier3.csv', function(error, csv){
//		tweets = csv.slice(0, 50);
		tweets = csv;
		renderList(tweets);
		var test = {};
		tweets.forEach(function(d, i){
			if(!test[d.events]) test[d.events] = [];
			var union = _.intersection(d.keywords.split(' '), _.keys(keywords));
			if(union.length > 0){
				test[d.events] = test[d.events].concat(union);
			}
		});

		var test2 = {};
		d3.keys(test).forEach(function(d, i){
			test2[d] = {};
			test[d].forEach(function(dB){
				test2[d][dB] = keywords[dB];
			});
		});

console.log(d3.keys(test));

//		console.log(JSON.stringify(test2));

	});

	function renderList(csv){
		csv.forEach(function(d, i){
			var regex = new RegExp('(' + d.keywords.split(' ').join('|') + ')', 'gi');
			d.formattedTweet = d.tweet.replace(regex, '<span class="keyword">$1</span>');
		});

		var tweetListFilled = compileTemplate(d3.select('#tweet-list-tpl').text(), csv);
		d3.select('#list-container .tweet-list').html(tweetListFilled);
	}

	// scroll manually and show the closest selected tweet
	var selectedTweetContainer = d3.select('#selected-tweet-container');
	var topTweetIndex = 0;
	d3.select('#list-container').on('scroll', _.throttle(function(d, i){
		if(!d3.event) return;
		var scrollTop = d3.event.srcElement.scrollTop;
		topTweetIndex = Math.floor(scrollTop/50);
		var topTweet = tweets[topTweetIndex];
		if(topTweet.selected){
			selectedTweetContainer.html(topTweet.formattedTweet);
		}
	}, 10));

	// scroll automatically to next selected tweet
	d3.select('.next-button').on('click', function(){
		var nextTweetIndex;
		var nextTopTweet = _.find(tweets.slice(topTweetIndex + 1, tweets.length), function(d, i){
			nextTweetIndex = i + topTweetIndex + 1;
			return d.selected;
		});

		topTweetIndex = nextTweetIndex;

		d3.select('#list-container').transition()
			.duration(1000)
			.tween("scroll", scrollTween(nextTweetIndex * 50));
	});

	function scrollTween(offset) {
		return function() {
			var i = d3.interpolateNumber(this.scrollTop, offset);
			return function(t) { this.scrollTop = i(t); };
		};
	}


</script>

</body>
</html>