<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title></title>
	<script type='text/javascript' src="lib/d3.js"></script>
	<script type='text/javascript' src="lib/underscore.js"></script>
	<script type='text/javascript' src="lib/render-queue.js"></script>
	<script type='text/javascript' src="keywords.js"></script>
<style>
	/* general */
	*{
		box-sizing: border-box;
		-webkit-backface-visibility: hidden;
	}
	div{
		border: 0px solid silver;
	}
	#outside-container{
		margin: 0 auto;
		max-width: 1100px;
		min-width: 610px;
		padding-top: 50px;
	}
	/* viz */
	text {
		font: 24px "Helvetica Neue", Helvetica, Arial, sans-serif;
		text-anchor: middle;
		pointer-events: none;
	}
	.legend text.legend-text{
		text-anchor: start;
		font-size: 12px;
		pointer-events: auto;
	}
	.legend g{
		cursor: pointer;
	}
	circle {
		fill: #ccc;
	}
	.node:hover circle{
		stroke: black;
		stroke-width: 3px;
	}
	.node.selected circle {
		stroke: red;
		stroke-width: 3px;
	}
	.top circle{
		fill: none;
		stroke: silver;
	}
	/* viz container */
	#visu{
		width: 400px;
		float: left;
	}
	#visu img{
		margin: 20px;
		position: absolute;
		cursor: pointer;
	}
	.tooltip{
		padding: 3px;
		height: 25px;
		border: 1px solid silver;
		position: absolute;
		pointer-events: none;
		display: none;
		background-color: white;
		opacity: 0.9;
	}
	/* tweet list */
	#inner-container{
		height: 500px;
	}
	#list-container{
		width: 600px;
		height: 500px;
		overflow: auto;
		float: left;
		margin-right: 50px;
	}
	.tweet-list{
		list-style-type: none;
		padding: 0;
		margin: 0;
	}
	.tweet-list li.tweet-list-element{
		height: 50px;
		border: 1px #eee solid;
		display: block;
	}
	.selected{
		background-color: aliceblue;
	}
	.keyword{
		color: gray;
	}
	.tweet-info{
		float: left;
	}
	.tweet-text{
		margin-left: 50px;
	}
	/* selected tweet */
	#selected-tweet-container{
		width: 100%;
		height: 150px;
		color: black;
		font-size: 32px;
		padding-top: 10px;
	}
	.date{
		font-size: 20px;
	}
	/* selection-info */
	#selection-info{
		float: left;
	}
	.label{
		font-weight: bold;
	}
</style>
</head>
<body>

<script type="template" id="tweet-list-tpl">
	<li class="tweet-list-element">
		<div class="tweet-info"><a href="https://twitter.com/MessierSRC"><img src="messier_avatar.jpeg" height="30"/></a></div>
		<div class="tweet-text">{formattedTweet}</div>
	</li>
</script>

<div id="outside-container">
	<div id="selected-tweet-container"></div>
	<div id="inner-container">
		<div id="list-container">
			<ul class="tweet-list"></ul>
		</div>
		<div id="visu">
			<div class="tooltip">test</div>
		</div>
		<div id="selection-info">
			Il y a <span class="label"><span class="count">0</span> tweets</span> dans la <span class="label">catégorie "<span class="category">Tout</span>"</span> contenant<br> le
			<span class="label">mot-clé "<span class="selected-keyword">Tout</span>"</span> que vous avez sélectionné<br>en cliquant sur la visualisation ci-dessus.
		</div>
	</div>
</div>

<script>


// Load tweets
////////////////////////////////////////////////////////
var tweets, filteredTweets;
d3.csv('magnotta_tweets_Messier7.csv', function(error, csv){
	tweets = csv;
	filteredTweets = tweets;
	formatAndRenderList();
	showNextSelectedTweet();
});


// Tweet list
////////////////////////////////////////////////////////
var compileTemplate = function(_template, _values){
	return [].concat(_values).map(function(d, i){
		return _template.replace(/{([^}]*)}/g, function(s, key){return d[key] || '';});
	}).join('\n');
};

var tweetListContainer = d3.select('#list-container .tweet-list');

// render the whole list
function formatAndRenderList(){
	// add classes for selected and keyword
	var keywordList =  keywords.map(function(d){ return d.keyword; });
	var regex = new RegExp('(' + keywordList.join('|[ \']') + ')', 'gi');
	tweets.forEach(function(d, i){
		if(d.selected === '1'){
			d.formattedTweet = '<span class="selected">' + d.tweet.replace(regex, '<span class="keyword">$1</span>') + '</span>';
		}
		else{
			d.formattedTweet = d.tweet.replace(regex, '<span class="keyword">$1</span>');
		}
	});

	// render html
	var tweetListFilled = compileTemplate(d3.select('#tweet-list-tpl').text(), tweets);
	tweetListContainer.html(tweetListFilled);
	countContainer.html(filteredTweets.length);
}

// scroll manually and show the closest selected tweet
var selectedTweetContainer = d3.select('#selected-tweet-container');
var topTweetIndex = 0;
var selectedTweetIndex = 0;
var listContainer = d3.select('#list-container').on('scroll', _.throttle(function(d, i){
	showNextSelectedTweet();
}, 10));

// scroll automatically to next selected tweet
d3.select('.next-button').on('click', function(){
	topTweetIndex = getTopTweet().index;
	removeFilterAroundIdx(topTweetIndex);
	scrollToNextSelectedTweet();
});

// filter the list
function getIndicesByKeyword(keyword){
	var indicesVisible = [];
	tweets.forEach(function(d, i){
		if(d.tweet.indexOf(keyword) > -1){
			indicesVisible.push(i);
		}
	});
	return indicesVisible.length > 0 ? indicesVisible : null;
}

function getIndicesByEvent(event){
	var indicesVisible = [];
	tweets.forEach(function(d, i){
		if(d.events === event){
			indicesVisible.push(i);
		}
	});
	return indicesVisible.length > 0 ? indicesVisible : null;
}

function filterList(indicesVisible){
	filteredTweets = [];
	var tweetList = tweetListContainer.selectAll('li')[0].map(function(d, i){
		return {element: d, idx: i}
	});

	var count = 0;
	var setDisplayStyle = function(opts){
		var isVisible = indicesVisible ? _.contains(indicesVisible, opts.idx) : true;
		opts.element.style.display = isVisible ? 'block': 'none';
		if(isVisible){
			count++;
		}
	};

	var setDisplayStyleQueued = renderQueue(setDisplayStyle)
		.rate(500)
		.done(function(){
			showTopTweet();
			countContainer.html(count);
		});

	setDisplayStyleQueued(tweetList);
}

// remove filter
function removeFilterAroundIdx(_idx){
	var idx = _idx || 0;
	filteredTweets = tweets;
	d3.selectAll('.tweet-list li').style({display: 'block'});
	listContainer.node().scrollTop = _idx * 50;
}

// find and show next selected tweet
function showNextSelectedTweet(next){
	var scrollTop = listContainer.node().scrollTop;
	topTweetIndex = Math.floor(scrollTop/50);
	var topTweet = filteredTweets[topTweetIndex];

	var tweetsSlice = filteredTweets.slice(topTweetIndex);
	if(next){ tweetsSlice.shift(); }
	var nextSelectedTweet = _.findWhere(tweetsSlice, {selected: '1'});
	if(nextSelectedTweet){
		if(!next){
			selectedTweetContainer.html(nextSelectedTweet.formattedTweet + '<br><span class="date">' + nextSelectedTweet.date + '</span>');
		}
		selectedTweetIndex = nextSelectedTweet.index;
	}
	return nextSelectedTweet;
}

// scroll to next selected tweet
function scrollToNextSelectedTweet(){
	var nextSelectedTweet = showNextSelectedTweet(true);
	if(nextSelectedTweet){
		d3.select('#list-container').transition()
			.duration(1000)
			.tween("scroll", scrollTween(selectedTweetIndex * 50));
	}
}

function scrollTween(offset) {
	return function() {
		var i = d3.interpolateNumber(this.scrollTop, offset);
		return function(t) { this.scrollTop = i(t); };
	};
}


// show top tweet
function getTopTweet(){
	var scrollTop = listContainer.node().scrollTop;
	topTweetIndex = Math.floor(scrollTop/50);
	var topTweet = filteredTweets[topTweetIndex];
	return topTweet;
}

function showTopTweet(){
	var topTweet = getTopTweet();
	if(topTweet){ selectedTweetContainer.html(topTweet.formattedTweet); }
}

// Legend
////////////////////////////////////////////////////////
function renderLegend(svg){
	// events name translation
	var eventsDisplayNames = {
		'arrestation': 'Arrestation',
		'Paris': 'Paris',
		'colis': 'Colis',
		'preuve': 'Preuve',
		'passe': 'Passé',
		'video': 'Vidéo',
		'video surveillance': 'Vidéo surveillance',
		'lin_jun': 'Lin Jun',
		'problemes_mentaux': 'Problèmes mentaux',
		'juridique': 'Juridique',
		'Berlin': 'Berlin',
		'Profil_témoin': 'Profil Témoin',
		'appartement': 'Appartement',
		'ambiance': 'Ambiance',
		'depart': 'Départ',
		'corps': 'Corps',
		'famille': 'Famille'
	};

	// build legend
	var maxR = 7;
	var legendGroup = svg.append('g')
		.classed('legend', true);

	// special all events legend element
	var legendAllR = maxR*2;
	var legendAll = legendGroup.append('g')
		.classed('legend-element-all', true)
		.attr({
			transform: 'translate(' + [legendAllR, legendAllR] + ')'
		})
		.on('click', function(d, i){
			renderBubbles(keywordsEntries);
			categoryContainer.style({'background-color': null}).html('Tout');
			keywordContainer.html('Tout');
			filterList();
		});
	legendAll.append('circle').attr({r: legendAllR})
		.style({
			fill: 'red'
		});
	legendAll.append('text').classed('legend-text', true)
		.attr({dx: legendAllR+4, dy: '4px'})
		.text(function(d){ return 'Tout'; });

	// legend elements
	var legend = legendGroup.selectAll('g.legend-element')
		.data(d3.entries(eventsList));
	var legendElements = legend.enter().append('g')
		.classed('legend-element', true)
		.attr({
			transform: function(d, i){ return 'translate(' + [legendAllR, i*maxR*2+maxR+legendAllR*2+i*2+2] + ')'; }
		})
		.on('click', function(d, i){
			var eventSelected = d.key;
			var keywordsEntriesFiltered = keywordsEntries.filter(function(d, i){ return d.event === eventSelected; });
			renderBubbles(keywordsEntriesFiltered);

			categoryContainer.style({'background-color': colors(eventSelected)}).html(eventSelected);
			keywordContainer.html('Tout');
			var indicesVisible = getIndicesByEvent(eventSelected);
			filterList(indicesVisible);
		});
	legendElements.append('circle').attr({r: maxR})
		.style({
			fill: function(d){ return colors(d.key); }
		});
	legendElements.append('text').classed('legend-text', true)
		.attr({dx: legendAllR+4, dy: '4px'})
		.text(function(d){ return eventsDisplayNames[d.key]; });
}

// Bubble chart
////////////////////////////////////////////////////////
var visuContainer = d3.select('#visu');

var eventsList = {};
var keywordsEntries = [];
keywords.forEach(function(d, i){
	keywordsEntries.push({key: d.keyword, value: d.count, event: d.event});
	if(typeof eventsList[d.event] === 'undefined'){
		eventsList[d.event] = 0;
	}
	eventsList[d.event]++;
});

var keywordContainer = d3.select('#selection-info .selected-keyword');
var categoryContainer = d3.select('#selection-info .category');
var countContainer = d3.select('#selection-info .count');
var tooltipContainer = d3.select('.tooltip');

var width = 400,
	height = 400,
	margins = {top: 20, right: 20, bottom: 20, left: 100};

var colors = d3.scale.category20c();

var pack = d3.layout.pack()
	.sort(null)
	.size([width, height])
	.padding(2)
	.value(function(d){return d.value; });

function renderBubbles(_keywordsEntries){

	var svg = visuContainer.select('svg');
	var svgGroup =svg.select('.top');
	if(!svgGroup[0][0]){
		var svg = visuContainer.append('svg')
			.attr({width: width + margins.left + margins.right, height: height + margins.top + margins.bottom});
		svgGroup = svg.append('g')
			.classed('top', true)
			.attr({transform: 'translate(' + [margins.left, margins.top] + ')'});
		renderLegend(svg);
	}

	var packData = pack.nodes({key: '', value: 1, children: _keywordsEntries}).filter(function(d) { return !d.children; });
	packData.forEach(function(d){ d.fontSize = ~~(d.r / d.key.length * 3); });

	var node = svgGroup.selectAll('g.node')
		.data(packData, function(d, i){ return d.key; });

	var nodeEnter = node.enter().append('g')
		.classed('node', function(d){ return d.depth > 0;})
		.attr({transform: function(d) { return 'translate(' + d.x + ',' + d.y + ')'; }});

	nodeEnter.append('circle')
		.style({opacity: 0})
		.attr({r: function(d){ return d.r; }})
		.on('mousemove', function(d, i){
			tooltipContainer.style({
					display: 'block',
					top: d3.event.y - 25 + 'px',
					left: d3.event.x + 'px'
				})
				.html(d.key);
		})
		.on('mouseout', function(d, i){
			var mousePos = d3.mouse(svg.node());
			tooltipContainer.style({
					display: 'none',
					top: mousePos[0] - 25 + 'px',
					left: d3.event.x + 'px'
				})
				.html(d.key);
		})
		.on('click', function(d, i){
			var indicesVisible = getIndicesByKeyword(d.key);
			filterList(indicesVisible);
			keywordContainer.html(d.key);
		});
	nodeEnter.append('text')
		.style({'font-size': '0px', opacity: 0});

	var nodeTransition = node.transition().duration(1000);
	nodeTransition.attr({transform: function(d) { return 'translate(' + d.x + ',' + d.y + ')'; }});
	nodeTransition.selectAll('circle')
		.style({
			fill: function(d, i){
				if(d.depth === 0) return null;
				return colors(d.event);
			},
			opacity: 1
		})
		.attr({r: function(d){ return d.r; }});
	nodeTransition.selectAll('text')
		.text(function(d){ return d.r > 10 ? d.key : ''; })
		.attr({dy: function(d){ return d.fontSize*0.35 + 'px'; }})
		.style({
			'font-size': function(d){
				return d.fontSize + 'px';
			},
			opacity: 1
		});

	node.exit().transition().style({opacity: 0}).remove();
}


renderBubbles(keywordsEntries);

</script>

</body>
</html>