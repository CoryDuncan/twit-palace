<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title></title>
	<script type='text/javascript' src="lib/d3.js"></script>
	<script type='text/javascript' src="render-slicer.js"></script>
	<script type='text/javascript' src="keywords_by_date.js"></script>
	<script type='text/javascript' src="bubble-chart.js"></script>
	<script type='text/javascript' src="slider.js"></script>
	<style>
		/* general */
		*{
			box-sizing: border-box;
			-webkit-backface-visibility: hidden;
		}
		body{
			font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
		}
		a{
			color: #7F7F7F;
		}
		div{
			border: 0px solid silver;
		}
		#outer-container{
			/*border: 1px solid silver*/
			width: 960px;
		}
		/* viz */
		text{
			font: 24px "Helvetica Neue", Helvetica, Arial, sans-serif;
			text-anchor: middle;
			pointer-events: none;
		}
		.legend text.legend-text{
			text-anchor: start;
			font-size: 12px;
			pointer-events: auto;
		}
		.legend g{
			cursor: pointer;
		}
		circle{
			fill: #ccc;
		}
		g.parent-node circle{
			fill: none !important;
			stroke: none !important;
		}
		.node:hover circle{
			stroke: black;
			stroke-width: 3px;
		}
		.node.selected circle {
			stroke: red;
			stroke-width: 3px;
		}
		.top circle{
			fill: none;
			stroke: silver;
		}
		/* viz container */
		#visu{
			float: left;
		}
		#visu-title, #tweet-list-title{
			height: 20px;
			font-weight: bold;
			font-size: 12px;
			line-height: 14px;
		}
		#tweet-list-title{

		}
		#tweets-container{
			width:300px;
			float:left;
		}
		/* tooltip */
		.tooltip{
			stroke: silver;
			pointer-events: none;
			display: none;
			fill: white;
			opacity: 0.9;
		}
		.tooltip text{
			fill: black;
			stroke: none;
			font-size: 24px;
		}
		/* tweet list */
		#list-container{
			width: 300px;
			height: 380px;
			float: left;
			overflow-y: scroll;
			padding-top: 30px;
		}
		.tweet-list{
			list-style-type: none;
			padding: 0;
			margin: 0;
		}
		.tweet-list li.tweet-list-element{
			height: 70px;
			border-bottom: 1px #eee solid;
			padding-top: 5px;
			display: block;
			font-size: 13px;
			line-height: 16px;
			color: #7F7F7F;
			text-decoration: none;
		}
		.twitter-link{
			font-size: 13px;
			line-height: 16px;
			color: #7F7F7F;
			text-decoration: none;
		 }
		.selected{
			background-color: aliceblue;
		}
		.keyword{
			color: gray;
		}
		.tweet-info{
			float: left;
		}
		.tweet-text{
			margin-left: 50px;
		}
		.tweet-list li.displayed-selected{
			border: 3px solid black;
		}
		#selection-info{
			float: left;
			width: 600px;
			height: 20px;
			margin-left: 60px;
			padding-bottom: 50px;
		}
		.info-date, .info-count{
			font-size: 18px;
			line-height: 18px;
		}
		.info-date{
			font-weight: bold;
		}
		/* selected tweet */
		#selected-tweet{
			width: 100%;
			height: 150px;
			color: black;
			font-size: 32px;
			padding-top: 10px;
			float: left;
		}
		.date{
			font-size: 20px;
		}
		#visu-container{
			width: 600px;
			float: left;
		}
		#embedded-tweet-container{
			width: 300px;
			height: 250px;
			float: left;
			opacity: 0;
		}
		#embedded-tweet-container iframe{
			height: 100%;
		}
		/* timeline */
		#slider-container{
			height: 70px;
			width: 600px;
			float: left;
			top: 0;
			background-image: url('timeline2.png');
			background-repeat: no-repeat;
			background-position: 60px 0px;
		}
		.slider{
			margin-top: 8px;
		}
		.slider-bg{
			cursor: pointer;
		}
		.slider-bg-styling
		{
			/*background-color: silver;*/
			height: 1px;
			cursor: pointer;
			top: 7px
		}
		.slider-handle, .playback-button, .next-button, .previous-button{
			cursor: pointer;
			border-radius: 5px;
		}
		.slider-handle{
			background-color: #d40000;
			border-radius: 10px;
			width: 9px !important;
			height: 30px !important;
			margin-top: -7px;
		}
		.playback-button.play{
			background-image: url('play3.png');
		}
		.playback-button.pause{
			background-image: url('pause3.png');
		}
		.next-button{
			background-image: url('next3.png');
		}
		.previous-button{
			background-image: url('prev3.png');
		}
		.axis-line{
			background-color: black;
		}
	</style>
</head>
<body>

<div id="outer-container">
	<div id="visu-container">
		<div id="visu-title">Mots clés des tweets #Magnotta</div>
		<div id="visu"></div>
		<div id="selection-info">
			<span class="info-date"></span>
			<span class="info-count"></span>
		</div>
		<div id="slider-container"></div>
	</div>
	<div id="tweets-container">
		<div id="tweet-list-title">Les tweets de la journée</div>
		<div id="embedded-tweet-container" data-cards="hidden" data-conversation="none"></div>
		<div id="list-container">
			<ul class="tweet-list"></ul>
		</div>
	</div>
	<div id="selected-tweet"></div>

</div>

<script type="template" id="tweet-list-tpl">
	<li class="tweet-list-element">
		<a class="twitter-link" href="{link}" target="_blank">
			<div class="tweet-info"><img src="{avatar}" height="30"/></div>
			<div class="tweet-text">{formattedTweet}</div>
		</a>
	</li>
</script>

<script>

	var d3_locale_frCA = d3.locale({
		decimal: ",",
		thousands: "\xa0",
		grouping: [3],
		currency: ["", "$"],
		dateTime: "%a %e %b %Y %X",
		date: "%Y-%m-%d",
		time: "%H:%M:%S",
		periods: ["", ""],
		days: ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
		shortDays: ["dim", "lun", "mar", "mer", "jeu", "ven", "sam"],
		months: ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
		shortMonths: ["jan", "fév", "mar", "avr", "mai", "jui", "jul", "aoû", "sep", "oct", "nov", "déc"]
	});

	var formatTime = function(dateAsString){
		return d3_locale_frCA.timeFormat('%-d %B %Y')(new Date(dateAsString));
	};

	function countOccurences(list){
		return list.reduce(function(pVal, val, i, arr){
			if(!pVal[val]){ pVal[val] = 0; }
			pVal[val]++;
			return pVal;
		}, {});
	}

	function compileTemplate(_template, _values){
		return [].concat(_values).map(function(d, i){
			return _template.replace(/{([^}]*)}/g, function(s, key){return d[key] || '';});
		}).join('\n');
	}

	var listContainer = d3.select('#list-container');
	var tweetListContainer = listContainer.select('.tweet-list');
	var selectionInfo = d3.select('#selection-info');
	var selectedTweetContainer = d3.select('#selected-tweet');
	var embeddedTweetContainer= d3.select('#embedded-tweet-container');

	// Slider
	////////////////////////////////////////////////////////
	var dates = d3.keys(keywords);
	var sortedDates = dates.map(function(d){ return new Date(d).getTime(); })
		.sort()
		.map(function(d){ return d3.time.format('%-m/%-d/%Y')(new Date(d)); });

	var dateLabel = d3.select('#label');

	var slider = slider().config({
			size: 450,
			max: sortedDates.length,
			transitionDuration: 55000,
			handleSize: 15
		})
		.on('change', function(index){
			renderTimeSlice(index);
		});
	d3.select('#slider-container').call(slider);

	// Bubble chart
	////////////////////////////////////////////////////////
	var chart = bubbleChart();
	d3.select('#visu').call(chart);

	function renderTimeSlice(value){
		var date = sortedDates[value-1];
		if(!date){
			renderTimeAll();
			return;
		}
		var keywordOccurences = keywords[date];
		var keywordsEntries = d3.entries(keywordOccurences);
		selectionInfo.select('.info-date').html(formatTime(date));
		selectionInfo.select('.info-count').html('');
		chart.renderBubbles(keywordsEntries);
		showSelectedTweet(date);
		setTimeout(function(date){
			var indices = getIndicesByDate(date);
			filterList(indices, date);
		}, 1000, date);
	}

	function renderTimeAll(){
		var allKeywords = d3.merge(d3.values(keywords).map(function(d){ return d3.keys(d)}));
		var keywordOccurences = countOccurences(allKeywords);
		var keywordsEntries = d3.entries(keywordOccurences);
		chart.renderBubbles(keywordsEntries);
		selectionInfo.select('.info-date')
			.html( d3_locale_frCA.timeFormat('%-d %B')(new Date(sortedDates[0])) + ' au ' + formatTime(sortedDates[sortedDates.length - 1]));
	}

	renderTimeAll();


	// Load tweets
	////////////////////////////////////////////////////////
	var tweets, filteredTweets, selectedTweets;
	window.onload = function(){
		d3.csv('magnotta_tweets_Messier_Richer5.csv', function(error, csv){
			tweets = csv;
			filteredTweets = tweets;
			formatAndRenderList();
			showSelectedTweet(sortedDates[0]);
		});
	};

	// Tweet list
	////////////////////////////////////////////////////////

	// render the whole list
	function formatAndRenderList(){
		var avatars = {'@MessierSRC': 'messier_avatar.jpeg', '@IsabelleRicher': 'richer_avatar.jpeg'};
		selectedTweets = {};
		// add classes for selected and keyword
		tweets.forEach(function(d, i){
			d.index = i;
			d.avatar = avatars[d.journalist];
			if(d.selected_by_day === '1'){
				d.formattedTweet = '<span class="selected">' + d.tweet + '</span>';
				selectedTweets[d.date] = d;
			}
			else{
				d.formattedTweet = d.tweet;
			}
		});

		// render html
		var tweetListFilled = compileTemplate(d3.select('#tweet-list-tpl').text(), tweets);
		tweetListContainer.html(tweetListFilled);
		selectionInfo.select('.info-count').html(filteredTweets.length + ' tweets');
	}

	function showSelectedTweet(date){
		if(!selectedTweets[date]) return;
		var link = selectedTweets[date].link;
		var id = link.split('/').slice(-1)[0];
		embeddedTweetContainer.style({opacity: 0}).html('');
		twttr.widgets.createTweet(id, embeddedTweetContainer.node())
			.then(function (el) {
					embeddedTweetContainer.transition().style({opacity: 1});
			});
	}

	// Filter list
	////////////////////////////////////////////////////////
	function getIndicesByKeyword(keyword){
		var matchString = new RegExp('[ ]' + keyword + '[^ ]?[ ]', 'i');
		var indicesVisible = [];
		tweets.forEach(function(d, i){
			if(d.tweet.match(matchString)){
				indicesVisible.push(i);
			}
		});
		return indicesVisible.length > 0 ? indicesVisible : null;
	}

	function getIndicesByDate(date){
		var indicesVisible = [];
		tweets.forEach(function(d, i){
			if(d.date === date){
				indicesVisible.push(i);
			}
		});
		return indicesVisible.length > 0 ? indicesVisible : null;
	}

	function filterList(indicesVisible, date){

		filteredTweets = [];
		var tweetList = tweetListContainer.selectAll('li')[0].map(function(d, i){
			return {element: d, idx: i}
		});

		var setDisplayStyle = function(opts){
			var isVisible = indicesVisible ? indicesVisible.indexOf(opts.idx) !== -1 : true;
			opts.element.style.display = isVisible ? 'block': 'none';
			if(isVisible){
				filteredTweets.push(tweets[opts.idx]);
			}
		};

		listContainer.node().scrollTop = 0;

		var setDisplayStyleQueued = renderSlicer(setDisplayStyle)
				.rate(200)
				.onDone(function(){
					selectionInfo.select('.info-count').html(filteredTweets.length + ' tweets');
				});

		setDisplayStyleQueued(tweetList);
	}


</script>

<script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>